{% extends "layout/base_dashboard.html" %}
{% load static %}

{% block title %}Eliminar usuario{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'cuentas/css/eliminar_usuario.css' %}">
{% endblock %}

{% block content %}
<div class="detalle-usuario">
  <h2 class="titulo-detalle">Eliminar usuario</h2>

  {# 游뛂 Defensa UX: si lleg칩 aqu칤 con su propio id, no mostrar el formulario #}
  {% if usuario.id == request.user.id %}
    <div class="alert alert-warning">
      No puedes eliminarte a ti mismo.
    </div>

    <a
      href="{% if tipo == 'padres' %}{% url 'cuentas:lista_padres' %}{% elif tipo == 'personal' %}{% url 'cuentas:lista_personal' %}{% else %}{% url 'cuentas:lista_usuarios' %}{% endif %}"
      class="btn-volver"
    >
      Volver
    </a>

  {% else %}

    <div class="card-detalle">
      <p>
        Est치 a punto de eliminar al usuario
        <strong>{{ usuario.get_full_name|default:usuario.nombres }}</strong>
        {% if usuario.rol %} <span class="label">({{ usuario.rol }})</span>{% endif %}.
      </p>

      {# Si tu view manda 'estudiantes', se listan; si no, se muestran contadores #}
      {% if estudiantes %}
        <p>Este usuario tiene los siguientes estudiantes asignados:</p>
        <ul class="lista-detalle">
          {% for estudiante in estudiantes %}
            <li>
              <span class="valor">{{ estudiante.apellidos }} {{ estudiante.nombres }}</span>
              {% if estudiante.curso %}
                <span class="label">{{ estudiante.curso.nivel }} {{ estudiante.curso.paralelo }}</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <ul class="lista-detalle">
          {% if n_estudiantes_asociados %}
            <li>
              <span class="valor">{{ n_estudiantes_asociados }}</span>
              <span class="label">estudiante(s) asociado(s)</span>
            </li>
          {% endif %}
          {% if n_cursos_regente %}
            <li>
              <span class="valor">{{ n_cursos_regente }}</span>
              <span class="label">curso(s) donde es regente</span>
            </li>
          {% endif %}
          {% if n_calendarios %}
            <li>
              <span class="valor">{{ n_calendarios }}</span>
              <span class="label">calendario(s) de asistencia creados por este usuario</span>
            </li>
          {% endif %}
          {% if not n_estudiantes_asociados and not n_cursos_regente and not n_calendarios %}
            <li><span class="label">No se encontraron dependencias relevantes.</span></li>
          {% endif %}
        </ul>
      {% endif %}
    </div>

    <form method="post" class="acciones-detalle">
      {% csrf_token %}

      {% if permite_forzado %}
        <div class="danger-zone">
          <label class="danger-check">
            <input type="checkbox" name="eliminar_todo" value="1">
            <span class="danger-text">
              <strong>Eliminar tambi칠n dependencias hist칩ricas</strong>
              <span class="muted">
                (Citaciones, K치rdex, Estudiantes asociados y/o Calendarios de asistencia).
              </span>
              <span class="warning">
                Esta acci칩n es <u>permanente</u> y no se puede deshacer.
              </span>
            </span>
          </label>
        </div>
      {% endif %}

      <div class="btns-row">
        <button type="submit" class="btn-eliminar">
          S칤, eliminar usuario
        </button>

        <a
          href="{% if tipo == 'padres' %}{% url 'cuentas:lista_padres' %}{% elif tipo == 'personal' %}{% url 'cuentas:lista_personal' %}{% else %}{% url 'cuentas:lista_usuarios' %}{% endif %}"
          class="btn-volver"
        >
          Cancelar
        </a>
      </div>
    </form>

    {% if nota_integridad %}
      <p class="nota">
        * Para preservar la integridad, si no marcas la casilla de borrado total y existen dependencias
        protegidas por el sistema, se intentar치 eliminar de forma segura si no es posible, el usuario
        se <strong>inactivar치</strong> y se te informar치.
      </p>
    {% endif %}

  {% endif %}
</div>
{% endblock %}
