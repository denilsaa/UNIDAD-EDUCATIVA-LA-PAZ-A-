{% extends "layout/base_dashboard.html" %}
{% load static %}
{% block title %}{{ titulo|default:"Editar Usuario" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'cuentas/css/editar_usuario.css' %}">
{% endblock %}

{% block content %}
  <form id="editar-usuario-form" method="post" class="form-usuario">
    <h2 class="titulo-form">
      {% if tipo == 'padres' %}Editar Usuario (Padre de familia){% else %}Editar Usuario (Personal){% endif %}
    </h2>
    {% csrf_token %}

    <!-- CI -->
    <div class="form-group">
      <label for="id_ci">CI:</label>
      <input type="text" id="id_ci" name="ci" class="form-control" value="{{ usuario.ci }}">
      <span id="ci-error"></span>
    </div>

    <!-- NOMBRES -->
    <div class="form-group">
      <label for="id_nombres">Nombres:</label>
      <input type="text" id="id_nombres" name="nombres" class="form-control" value="{{ usuario.nombres }}">
      <span id="nombres-error"></span>
    </div>

    <!-- APELLIDOS -->
    <div class="form-group">
      <label for="id_apellidos">Apellidos:</label>
      <input type="text" id="id_apellidos" name="apellidos" class="form-control" value="{{ usuario.apellidos }}">
      <span id="error-apellidos"></span>
    </div>

    <!-- EMAIL -->
    <div class="form-group">
      <label for="id_email">Correo electrónico:</label>
      <input type="text" id="id_email" name="email" class="form-control" value="{{ usuario.email }}">
      <span id="error-email"></span>
    </div>

    <!-- TELÉFONO -->
    <div class="form-group">
      <label for="id_telefono">Teléfono:</label>
      <input type="text" id="id_telefono" name="telefono" class="form-control" value="{{ usuario.telefono }}">
      <span id="error-telefono"></span>
    </div>

    <!-- ROL -->
    <p>{{ form.rol.label_tag }} {{ form.rol }}</p>
    <span id="error-rol" class="error-msg"></span>

    <!-- ACTIVO -->
    <div class="form-group">
      <label for="id_is_activo" class="form-check-label">Estado del usuario:</label>
      <div>
        {% if usuario.id == request.user.id %}
          <input
            type="checkbox"
            id="id_is_activo"
            name="is_activo"
            class="checkbox-input"
            checked
            disabled
            title="No puedes inactivarte a ti mismo"
          >
          <input type="hidden" name="is_activo" value="on">
          <small class="text-muted">No puedes inactivarte a ti mismo.</small>
        {% else %}
          <input
            type="checkbox"
            id="id_is_activo"
            name="is_activo"
            class="checkbox-input"
            {% if usuario.is_activo %}checked{% endif %}
          >
        {% endif %}

        <span id="estado-texto">
          {% if usuario.is_activo %}Activo{% else %}Inactivo{% endif %}
        </span>
      </div>
    </div>

    <!-- CAMBIO DE CONTRASEÑA -->
    <fieldset class="fieldset-password">
      <legend>Nueva contraseña (opcional)</legend>

      <div class="form-group">
        <label for="new_password1">Nueva contraseña:</label>
        <input type="password" id="new_password1" name="new_password1" class="form-control">
        <div id="pass-msg"></div>
      </div>

      <div class="form-group">
        <label for="new_password2">Confirmar nueva contraseña:</label>
        <input type="password" id="new_password2" name="new_password2" class="form-control">
      </div>
    </fieldset>

    <!-- BOTONES -->
    <p class="form-actions">
      <button type="submit">Guardar</button>
      <a href="{% url 'cuentas:ver_usuario' usuario.id %}">Ver</a>
      {% if tipo == 'padres' %}
        <a href="{% url 'cuentas:lista_padres' %}">Volver</a>
      {% else %}
        <a href="{% url 'cuentas:lista_personal' %}">Volver</a>
      {% endif %}
    </p>
  </form>

{% block scripts %}
<script>
  window.usuarioContext = {
    logueadoId: "{{ request.user.id }}",
    editadoId: "{{ usuario.id }}",
    rolEditado: "{{ usuario.rol|escapejs }}"
  };
</script>
<script src="{% static 'cuentas/js/editar_usuario.js' %}"></script>
<script>
  (function(){
    var cb = document.getElementById('id_is_activo');
    var label = document.getElementById('estado-texto');
    if (!cb || cb.disabled) return;
    cb.addEventListener('change', function(){
      label.textContent = cb.checked ? 'Activo' : 'Inactivo';
    });
  })();
</script>
{% endblock %}
{% endblock %}
