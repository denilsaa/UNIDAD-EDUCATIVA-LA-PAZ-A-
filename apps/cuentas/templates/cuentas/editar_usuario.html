{% extends "layout/base_dashboard.html" %}
{% load static %}
{% block title %}Editar Usuario{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'cuentas/css/editar_usuario.css' %}">
{% endblock %}

{% block content %}

  <form id="editar-usuario-form" method="post" class="form-usuario">
    <h2 class="titulo-form">Editar Usuario</h2>
    {% csrf_token %}

    <!-- CI -->
    <div class="form-group">
      <label for="id_ci">CI:</label>
      <input type="text" id="id_ci" name="ci" class="form-control" value="{{ usuario.ci }}">
      <span id="ci-error"></span>
    </div>

    <!-- NOMBRES -->
    <div class="form-group">
      <label for="id_nombres">Nombres:</label>
      <input type="text" id="id_nombres" name="nombres" class="form-control" value="{{ usuario.nombres }}">
      <span id="nombres-error"></span>
    </div>

    <!-- APELLIDOS -->
    <div class="form-group">
      <label for="id_apellidos">Apellidos:</label>
      <input type="text" id="id_apellidos" name="apellidos" class="form-control" value="{{ usuario.apellidos }}">
      <span id="error-apellidos"></span>
    </div>

    <!-- EMAIL -->
    <div class="form-group">
      <label for="id_email">Correo electr칩nico:</label>
      <input type="text" id="id_email" name="email" class="form-control" value="{{ usuario.email }}">
      <span id="error-email"></span>
    </div>

    <!-- TEL칄FONO -->
    <div class="form-group">
      <label for="id_telefono">Tel칠fono:</label>
      <input type="text" id="id_telefono" name="telefono" class="form-control" value="{{ usuario.telefono }}">
      <span id="error-telefono"></span>
    </div>

    <!-- ROL -->
    <p>{{ form.rol.label_tag }} {{ form.rol }}</p>

    <!-- ACTIVO -->
    <div class="form-group">
      <label for="id_is_activo" class="form-check-label">Estado del usuario:</label>
      <div>
        {# 游뛂 Si estoy editando mi propio usuario, no permito inactivarme #}
        {% if usuario.id == request.user.id %}
          <input
            type="checkbox"
            id="id_is_activo"
            name="is_activo"
            class="checkbox-input"
            checked
            disabled
            title="No puedes inactivarte a ti mismo"
          >
          {# Importante: como el checkbox est치 disabled, env칤o un hidden para mantener 'on' en el POST #}
          <input type="hidden" name="is_activo" value="on">
          <small class="text-muted">No puedes inactivarte a ti mismo.</small>
        {% else %}
          <input
            type="checkbox"
            id="id_is_activo"
            name="is_activo"
            class="checkbox-input"
            {% if usuario.is_activo %}checked{% endif %}
          >
        {% endif %}

        <span id="estado-texto">
          {% if usuario.is_activo %}Activo{% else %}Inactivo{% endif %}
        </span>
      </div>
    </div>

    <!-- CAMBIO DE CONTRASE칌A -->
    <fieldset class="fieldset-password">
      <legend>Nueva contrase침a (opcional)</legend>

      <!-- Nueva contrase침a -->
      <div class="form-group">
        <label for="new_password1">Nueva contrase침a:</label>
        <input type="password" id="new_password1" name="new_password1" class="form-control">
        <!-- Bloque donde se insertar치n los requisitos -->
        <div id="pass-msg"></div>
      </div>

      <!-- Confirmaci칩n -->
      <div class="form-group">
        <label for="new_password2">Confirmar nueva contrase침a:</label>
        <input type="password" id="new_password2" name="new_password2" class="form-control">
      </div>
    </fieldset>

    <!-- BOTONES -->
    <p class="form-actions">
      <button type="submit">Guardar</button>
      <a href="{% url 'cuentas:ver_usuario' usuario.id %}">Ver</a>
      <a href="{% url 'cuentas:lista_usuarios' %}">Volver</a>
    </p>
  </form>

{% block scripts %}
<script src="{% static 'cuentas/js/editar_usuario.js' %}"></script>
<script>
  // Si el checkbox est치 habilitado, actualiza el texto "Activo/Inactivo" al vuelo.
  (function(){
    var cb = document.getElementById('id_is_activo');
    var label = document.getElementById('estado-texto');
    if (!cb || cb.disabled) return;
    cb.addEventListener('change', function(){
      label.textContent = cb.checked ? 'Activo' : 'Inactivo';
    });
  })();
</script>
{% endblock %}
{% endblock %}
