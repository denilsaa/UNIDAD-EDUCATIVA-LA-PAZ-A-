{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Panel{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'cuentas/css/dashboard.css' %}">
  {% block extra_css %}{% endblock %}
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Evitar cachÃ© en pÃ¡ginas autenticadas -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Estilos mÃ­nimos para campana, badge y panel (puedes moverlos a tu CSS) -->
  <style>
    .topbar {
      display:flex; align-items:center; justify-content:flex-end;
      gap:8px; padding:10px 12px; border-bottom:1px solid #eee;
      background:#fff; position:sticky; top:0; z-index:20;
    }
    .notif-bell {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px; height: 40px;
      border: 0; border-radius: 999px;
      background: transparent;
      cursor: pointer;
      transition: background .2s ease;
    }
    .notif-bell:hover { background: rgba(0,0,0,.06); }
    .notif-bell svg { width: 22px; height: 22px; fill: currentColor; color: #333; }

    .notif-badge {
      position: absolute; top: -4px; right: -2px;
      min-width: 18px; height: 18px; padding: 0 6px;
      border-radius: 999px; background: #e11; color: #fff;
      font-size: 12px; line-height: 18px; text-align: center;
      box-shadow: 0 0 0 2px #fff;
      display:none;
    }

    .notif-panel {
      position: fixed; top: 0; right: 0; bottom: 0;
      width: min(380px, 92vw); background: #fff;
      box-shadow: -12px 0 30px rgba(0,0,0,.12);
      z-index: 10000; display: flex; flex-direction: column;
    }
    .notif-panel[hidden] { display:none; }
    .notif-panel__hdr {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px; border-bottom: 1px solid #eee;
    }
    .notif-panel__content { padding: 12px 14px; overflow: auto; flex: 1; }
    .notif-close {
      border:none; background:transparent; font-size:18px; cursor:pointer;
      padding:4px 8px; border-radius:8px;
    }
    .notif-close:hover { background:rgba(0,0,0,.06); }
  </style>
</head>

{% with role=request.user.rol.nombre|default_if_none:""|default:""|lower %}
<body class="layout">
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidenav">
      <nav>
        <!-- Texto superior -->
        <div class="sidebar-header">
          <h1 class="hdr-title">Unidad Educativa La Paz â€œAâ€</h1>
        </div>

        <!-- Imagen centrada -->
        <div class="sidebar-image">
          <img src="{% static 'img/logo.png' %}" alt="Logo UE" />
        </div>

        <!-- Secciones -->
        <h2 class="sidenav-title">Secciones</h2>
        <ul class="sidenav-list">
          {# --- Director --- #}
          {% if "director" in role %}
            <li><a href="{% url 'cuentas:director_dashboard' %}">ğŸ“Š Resumen</a></li>
            <li><a href="{% url 'cuentas:lista_usuarios' %}">ğŸ‘¤ Usuarios</a></li>
            <li><a href="{% url 'cursos:lista_cursos' %}">ğŸ“š Cursos</a></li>

            <li><a href="{% url 'estudiantes:asistencia_calendario' %}">ğŸ—“ï¸ Calendario asistencia</a></li>
            <li><a href="{% url 'cursos:lista_cursos' %}">ğŸ“‹ Tomar asistencia</a></li>

            <li><a href="{% url 'cuentas:crear_usuario' %}">â• Nuevo usuario</a></li>
            <li><a href="{% url 'cursos:crear_curso' %}">â• Nuevo curso</a></li>
            <li><a href="{% url 'estudiantes:kardex_items_listar' %}">ğŸ—‚ï¸ KÃ¡rdex</a></li>

            <!-- ğŸ‘‡ NUEVO: Bandeja de aprobaciÃ³n de citaciones -->
            <li><a href="{% url 'citaciones:pendientes' %}">ğŸ“‘ Citaciones</a></li>

            <li class="sep"></li>
            <li><a href="{% url 'estudiantes:listar' %}">ğŸ‘¥ Estudiantes</a></li>
            <li><a href="{% url 'estudiantes:crear' %}">â• Nuevo estudiante</a></li>
          {% elif "regente" in role %}


          {# --- Regente --- #}
          {% elif "regente" in role %}
            <li><a href="{% url 'cuentas:regente_dashboard' %}">ğŸ“Š Resumen</a></li>
            <li><a href="{% url 'cursos:mis_cursos_regente' %}">ğŸ“š Mis cursos</a></li>
            <!-- ğŸ‘‡ NUEVO: Tomar asistencia (Regente) va por sus cursos -->
            <li><a href="{% url 'cursos:mis_cursos_regente' %}">ğŸ“‹ Tomar asistencia</a></li>

          {# --- SecretarÃ­a --- #}
          {% elif "secretaria" in role or "secretarÃ­a" in role %}
            <li><a href="{% url 'cuentas:secretaria_dashboard' %}">ğŸ“Š Resumen</a></li>
            <li><a href="{% url 'cuentas:lista_usuarios' %}">ğŸ“„ Usuarios</a></li>
            <li class="sep"></li>
            <li><a href="{% url 'estudiantes:listar' %}">ğŸ‘¥ Estudiantes</a></li>
            <li><a href="{% url 'estudiantes:crear' %}">â• Nuevo estudiante</a></li>
            <li><a href="{% url 'estudiantes:kardex_items_listar' %}">ğŸ—‚ï¸ KÃ¡rdex</a></li>

          {# --- Padre de familia --- #}
          {% elif "padre" in role %}
            <li><a href="{% url 'cuentas:padre_dashboard' %}">ğŸ  Inicio</a></li>
            <li><a href="{% url 'estudiantes:mis_hijos' %}">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Mis hijos</a></li>
            <!-- Para ver asistencia, entra al detalle del hijo -->
          {% endif %}

          <li class="sep"></li>
          <li><a href="{% url 'cuentas:logout' %}">ğŸšª Cerrar sesiÃ³n</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Contenido -->
    <main class="main">

      <!-- Topbar con campana -->
      <div class="topbar">
        <!-- Campana de notificaciones -->
        <button id="notif-bell" class="notif-bell" type="button" aria-label="Notificaciones">
          <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
            <path d="M12 2a6 6 0 0 0-6 6v3.586l-.707.707A1 1 0 0 0 6 14h12a1 1 0 0 0 .707-1.707L18 11.586V8a6 6 0 0 0-6-6zm0 20a3 3 0 0 0 2.995-2.824L15 19h-6a3 3 0 0 0 2.824 2.995L12 22z"/>
          </svg>
          <!-- Badge que el WS actualiza -->
          <span id="notif-badge" class="notif-badge">0</span>
        </button>
      </div>

      <!-- Mensajes Django -->
      {% if messages %}
        <div class="msgs">
          {% for message in messages %}
            <div class="msg msg-{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Panel lateral de notificaciones (opcional) -->
  <aside id="notif-panel" class="notif-panel" hidden>
    <header class="notif-panel__hdr">
      <strong>Notificaciones</strong>
      <button type="button" id="notif-close" class="notif-close" aria-label="Cerrar">âœ•</button>
    </header>
    <div class="notif-panel__content">
      <p style="opacity:.7">Sin notificaciones aÃºn.</p>
    </div>
  </aside>

  <!-- Scripts -->
  <script>
    // Abrir/cerrar sidebar (si lo usas en responsive)
    function toggleSidebar() {
      const sidenav = document.querySelector('.sidenav');
      if (sidenav) sidenav.classList.toggle('open');
    }

    /*
      Evitar "volver atrÃ¡s" en pÃ¡ginas autenticadas:
      - Si el usuario presiona AtrÃ¡s, recargamos la misma URL (location.replace).
      - Si la pÃ¡gina viene del back/forward cache (bfcache), forzamos recarga.
      Con headers no-store, si la sesiÃ³n expirÃ³, Django te enviarÃ¡ al login.
    */
    (function () {
      try {
        var navEntries = performance.getEntriesByType && performance.getEntriesByType('navigation');
        if (navEntries && navEntries[0] && navEntries[0].type === 'back_forward') {
          location.replace(location.href);
          return;
        }
      } catch (_) {}

      window.addEventListener('pageshow', function (evt) {
        if (evt.persisted) {
          location.replace(location.href);
        }
      });

      try { history.replaceState({ locked: true }, '', location.href); } catch (_) {}

      window.addEventListener('popstate', function () {
        location.replace(location.href);
      });
    })();
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    // ------- Overlay SOLO cuando hay salida de la pÃ¡gina (navegaciÃ³n real) ------
    function showOverlay() {
      if (document.getElementById("ui-lock")) return;
      const ov = document.createElement("div");
      ov.id = "ui-lock";
      ov.innerHTML = '<div class="ui-lock__box"><div class="ui-lock__spinner"></div><p>Procesandoâ€¦</p></div>';
      Object.assign(ov.style, {
        position:"fixed", inset:"0", zIndex:"9999",
        background:"rgba(255,255,255,.6)",
        display:"flex", alignItems:"center", justifyContent:"center",
        backdropFilter:"saturate(180%) blur(2px)"
      });
      document.body.appendChild(ov);
      document.body.style.overflow = "hidden";
    }
    window.addEventListener("beforeunload", showOverlay);

    // ------- 1) Anti double-submit por formulario (no tocar disabled/value) ----
    document.querySelectorAll("form").forEach(form => {
      let submitting = false;
      form.addEventListener("submit", function (e) {
        if (submitting) { e.preventDefault(); e.stopPropagation(); return false; }
        submitting = true;
        const btn = form.querySelector("button[type=submit], input[type=submit]");
        if (btn) btn.classList.add("is-loading");
      }, true);
    });

    // ------- 2) Debounce para ENLACES y overlay sÃ³lo si navegan -----------------
    document.querySelectorAll("a[href]").forEach(link => {
      link.addEventListener("click", function (e) {
        const href = link.getAttribute("href") || "";
        if (href.startsWith("#")) return;

        if (link.dataset.clicked === "true") {
          e.preventDefault(); e.stopPropagation(); return false;
        }
        link.dataset.clicked = "true";
        setTimeout(() => { link.dataset.clicked = "false"; }, 4000);
      }, { capture:true });
    });

    // Limpieza si el navegador usa bfcache
    window.addEventListener("pageshow", function (evt) {
      if (evt.persisted) {
        const ov = document.getElementById("ui-lock");
        if (ov) ov.remove();
        document.body.style.overflow = "";
      }
    });

    // Toggle panel notificaciones
    (function(){
      const bell = document.getElementById('notif-bell');
      const panel = document.getElementById('notif-panel');
      const closeBtn = document.getElementById('notif-close');

      if (bell && panel) {
        bell.addEventListener('click', () => { panel.hidden = !panel.hidden; });
      }
      if (closeBtn && panel) {
        closeBtn.addEventListener('click', () => { panel.hidden = true; });
      }
    })();
  });
  </script>

  <script>
  (function(){
    // Ajusta host si no es localhost
    const WS = (path) => {
      const proto = (location.protocol === "https:") ? "wss" : "ws";
      return `${proto}://${location.host}${path}`;
    };

    // --- Notificaciones (simula uid=1) ---
    const notifSocket = new WebSocket(WS("/ws/notifs/?uid=1"));
   notifSocket.onmessage = (e) => {
  const msg = JSON.parse(e.data);

  // 1) NotificaciÃ³n al PADRE (campana)
  if (msg.type === "notif") {
    const badge = document.getElementById("notif-badge");
    if (badge && typeof msg.data.unread !== "undefined") {
      const curr = parseInt(badge.textContent || "0", 10);
      badge.textContent = (curr + (parseInt(msg.data.unread,10)||0)).toString();
      badge.style.display = "inline-block";
    }
    const panel = document.getElementById('notif-panel');
    const content = document.querySelector('.notif-panel__content');
    if (panel && content && msg.data && msg.data.event === "citacion") {
      const row = document.createElement('div');
      row.style.padding = "8px 0";
      row.style.borderBottom = "1px solid #f3f3f3";
      row.innerHTML = `<strong>CitacioÌn #${msg.data.citacion_id}</strong><br>
                       <small>${msg.data.estudiante} â€” ${msg.data.mensaje}</small><br>
                       <small>${msg.data.cuando || ''}</small>`;
      content.prepend(row);
    }
    return;
  }

  // 2) Propuesta al DIRECTOR (inbox)
  if (msg.type === "director_inbox") {
    const content = document.querySelector('.notif-panel__content');
    if (content) {
      const d = msg.data || {};
      const row = document.createElement('div');
      row.style.padding = "10px 0";
      row.style.borderBottom = "1px solid #eee";
      row.innerHTML = `
        <strong>Propuesta de citaciÃ³n</strong><br>
        <small>#${d.citacion_id} Â· ${d.estudiante}</small><br>
        <small>${d.motivo} Â· ${d.razon}</small><br>
        <small>Ïâ‰ˆ${(d.rho||0).toFixed(2)} Â· Wqâ‰ˆ${d.Wq? d.Wq.toFixed(1) : "â€”"} min</small><br>
        <small>Sugerido: ${d.sugerido ? new Date(d.sugerido).toLocaleString() : "â€”"}</small><br>
        <a href="${window.location.origin}/citaciones/pendientes/" class="btn btn-sm btn-primary" style="margin-top:6px; display:inline-block;">Revisar</a>
      `;
      content.prepend(row);
    }
    return;
  }

  console.log("[WS NOTIF RAW]", msg);
};

    // --- Cola ---
    const colaSocket = new WebSocket(WS("/ws/cola/"));
    colaSocket.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      console.log("[WS COLA]", msg.data);
    };

    // --- Dashboard ---
    const dashSocket = new WebSocket(WS("/ws/dashboard/"));
    dashSocket.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      console.log("[WS DASH]", msg.data);
      // AquÃ­ luego pintamos semÃ¡foro y mÃ©tricas
    };
  })();
(function(){
  const WS = (path) => {
    const proto = (location.protocol === "https:") ? "wss" : "ws";
    // Fuerza la misma IP/puerto donde corre Daphne
    const host = "127.0.0.1:8000";
    return `${proto}://${host}${path}`;
  };

  function wire(name, url){
    const s = new WebSocket(url);
    s.onopen  = () => console.log(`[WS ${name}] OPEN`, url);
    s.onerror = (e) => console.warn(`[WS ${name}] ERROR`, e);
    s.onclose = (e) => console.warn(`[WS ${name}] CLOSE`, e.code, e.reason);
    s.onmessage = (e) => {
      try { console.log(`[WS ${name}] MSG`, JSON.parse(e.data)); }
      catch { console.log(`[WS ${name}] MSG`, e.data); }
    };
    return s;
  }

  wire("NOTIFS", WS("/ws/notifs/?uid=1"));
  wire("COLA",   WS("/ws/cola/"));
  wire("DASH",   WS("/ws/dashboard/"));
})();
  </script>

</body>
{% endwith %}
</html>
