{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Panel{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'cuentas/css/dashboard.css' %}">
  {% block extra_css %}{% endblock %}
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Evitar cachÃ© en pÃ¡ginas autenticadas -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>

{% with role=request.user.rol.nombre|default_if_none:""|default:""|lower %}
<body class="layout">
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidenav">
      <nav>
        <!-- Texto superior -->
        <div class="sidebar-header">
          <h1 class="hdr-title">Unidad Educativa La Paz â€œAâ€</h1>
        </div>

        <!-- Imagen centrada -->
        <div class="sidebar-image">
          <img src="{% static 'img/logo.png' %}" alt="Logo UE" />
        </div>
        <!-- Secciones -->
        <h2 class="sidenav-title">Secciones</h2>
        <ul class="sidenav-list">
          {# --- Director --- #}
          {% if "director" in role %}
            <li><a href="{% url 'cuentas:director_dashboard' %}">ğŸ“Š Resumen</a></li>
            <li><a href="{% url 'cuentas:lista_personal' %}">ğŸ‘¤ Usuarios</a></li>
            <li><a href="{% url 'cursos:lista_cursos' %}">ğŸ“š Cursos</a></li>

            <li><a href="{% url 'estudiantes:asistencia_calendario' %}">ğŸ—“ï¸ Calendario asistencia</a></li>
            <li><a href="{% url 'cursos:lista_cursos' %}">ğŸ“‹ Tomar asistencia</a></li>

            <li><a href="{% url 'cuentas:crear_personal' %}">â• Nuevo usuario</a></li>
            <li><a href="{% url 'cursos:crear_curso' %}">â• Nuevo curso</a></li>
            <li><a href="{% url 'estudiantes:kardex_items_listar' %}">ğŸ—‚ï¸ KÃ¡rdex</a></li>

            <!-- ğŸ‘‡ Bandejas de citaciones -->
            <li><a href="{% url 'citaciones:pendientes' %}">ğŸ“‘ Citaciones por aprobar</a></li>
            <li><a href="{% url 'citaciones:agendadas_rango' %}">ğŸ“‘ Citaciones agendadas</a></li>

            <!-- ğŸ‘‡ NUEVO: Historial de estudiantes (auditorÃ­a) -->
            <li><a href="{% url 'auditoria:historial_estudiantes' %}">ğŸ“ Historial estudiantes</a></li>

            <li class="sep"></li>
            <li><a href="{% url 'estudiantes:listar' %}">ğŸ‘¥ Estudiantes</a></li>
            <li><a href="{% url 'estudiantes:crear' %}">â• Nuevo estudiante</a></li>
            <li><a href="{% url 'cuentas:lista_padres' %}">ğŸ‘¥ Padre de Familia</a></li>
            <li><a href="{% url 'cuentas:crear_padre' %}">â• Nuevo Padre</a></li>
          {# --- Regente --- #}
          {% elif "regente" in role %}
            <li><a href="{% url 'cuentas:regente_dashboard' %}">ğŸ“Š Resumen</a></li>
            <li><a href="{% url 'cursos:mis_cursos_regente' %}">ğŸ“š Mis cursos</a></li>
            <!-- ğŸ‘‡ NUEVO: Tomar asistencia (Regente) va por sus cursos -->
            <li><a href="{% url 'cursos:mis_cursos_regente' %}">ğŸ“‹ Tomar asistencia</a></li>

          {# --- SecretarÃ­a --- #}
          {% elif "secretaria" in role or "secretarÃ­a" in role %}
            <li><a href="{% url 'cuentas:secretaria_dashboard' %}">ğŸ“Š Resumen</a></li>
            <li><a href="{% url 'cuentas:lista_usuarios' %}">ğŸ“„ Usuarios</a></li>
            <li class="sep"></li>
            <li><a href="{% url 'estudiantes:listar' %}">ğŸ‘¥ Estudiantes</a></li>
            <li><a href="{% url 'estudiantes:crear' %}">â• Nuevo estudiante</a></li>
            <li><a href="{% url 'estudiantes:kardex_items_listar' %}">ğŸ—‚ï¸ KÃ¡rdex</a></li>

          {# --- Padre de familia --- #}
          {% elif "padre" in role %}
            <li><a href="{% url 'cuentas:padre_dashboard' %}">ğŸ  Inicio</a></li>
            <li><a href="{% url 'estudiantes:mis_hijos' %}">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Mis hijos</a></li>
            <!-- Para ver asistencia, entra al detalle del hijo -->
          {% endif %}

          <li class="sep"></li>
          <li><a href="{% url 'cuentas:logout' %}">ğŸšª Cerrar sesiÃ³n</a></li>
        </ul>


      </nav>
    </aside>

    <!-- Contenido -->
    <main class="main">

      <!-- Topbar con campana -->
      <div class="topbar">
        <!-- Campana de notificaciones -->
        <button id="notif-bell" class="notif-bell" type="button" aria-label="Notificaciones">
          <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
            <path d="M12 2a6 6 0 0 0-6 6v3.586l-.707.707A1 1 0 0 0 6 14h12a1 1 0 0 0 .707-1.707L18 11.586V8a6 6 0 0 0-6-6zm0 20a3 3 0 0 0 2.995-2.824L15 19h-6a3 3 0 0 0 2.824 2.995L12 22z"/>
          </svg>
          <!-- Badge que el WS actualiza + valor inicial desde BD -->
          <span
            id="notif-badge"
            class="notif-badge"
            {% if not notif_panel_unread %}style="display:none"{% endif %}
          >
            {{ notif_panel_unread|default:0 }}
          </span>
        </button>
      </div>

      <!-- Mensajes Django -->
      {% if messages %}
        <div class="msgs">
          {% for message in messages %}
            <div class="msg msg-{{ message.tags }}">
              {% if message.tags == 'success' %}
                <img src="{% static 'img/Correcto_Img.png' %}" alt="ok">
              {% elif message.tags == 'error' or message.tags == 'danger' %}
                <img src="{% static 'img/Error_Img.png' %}" alt="error">
              {% elif message.tags == 'info' %}
                <img src="{% static 'img/Informacion.png' %}" alt="info">
              {% endif %}
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Panel lateral de notificaciones (opcional) -->
<aside id="notif-panel" class="notif-panel" hidden>
  <header class="notif-panel__hdr">
    <strong>Notificaciones</strong>
    <button type="button" id="notif-close" class="notif-close" aria-label="Cerrar">âœ•</button>
  </header>
  <div class="notif-panel__content">
    {% if notif_panel_list %}
      {% for n in notif_panel_list %}
        <div class="notif-item" style="padding:8px 0; border-bottom:1px solid #f3f3f3">
          <strong>
            {% if n.citacion_id %}
              CitaciÃ³n #{{ n.citacion_id }}
            {% else %}
              NotificaciÃ³n
            {% endif %}
          </strong><br>
          {% if n.citacion and n.citacion.estudiante %}
            {{ n.citacion.estudiante }} â€”
          {% endif %}
          {{ n.cuerpo }}
          <br>
          <small style="opacity:.7">{{ n.enviada_en }}</small>
        </div>
      {% endfor %}
    {% else %}
      <p data-no-notifs="1" style="opacity:.7">Sin notificaciones aÃºn.</p>
    {% endif %}
  </div>
</aside>

  {{ request.user.id|default:0|json_script:"user-id" }}
  {{ request.user.rol.nombre|default:''|json_script:"user-role" }}

  <script>
    window.userData = {
      id: JSON.parse(document.getElementById('user-id').textContent),
      role: JSON.parse(document.getElementById('user-role').textContent)
    };
  </script>
  <!-- Scripts -->
  {% block extra_js %}
    <script src="{% static 'cuentas/js/base_dashboard.js' %}"></script>
  {% endblock %}
  {% block scripts %}{% endblock %}
</body>
{% endwith %}
</html>