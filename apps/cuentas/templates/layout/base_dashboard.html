{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Panel{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'cuentas/css/dashboard.css' %}">
  {% block extra_css %}{% endblock %}
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Evitar caché en páginas autenticadas -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>

{% with role=request.user.rol.nombre|default_if_none:""|default:""|lower %}
<body class="layout">
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidenav">
      <nav>
        <!-- Texto superior -->
        <div class="sidebar-header">
          <h1 class="hdr-title">Unidad Educativa La Paz “A”</h1>
        </div>

        <!-- Imagen centrada -->
        <div class="sidebar-image">
          <img src="{% static 'img/logo.png' %}" alt="Logo UE" />
        </div>

        <!-- Secciones -->
        <h2 class="sidenav-title">Secciones</h2>
        <ul class="sidenav-list">

          {# --- Director --- #}
          {% if "director" in role %}
            <li><a href="{% url 'cuentas:director_dashboard' %}">📊 Resumen</a></li>
            <li><a href="{% url 'cuentas:lista_usuarios' %}">👤 Usuarios</a></li>
            <li><a href="{% url 'cursos:lista_cursos' %}">📚 Cursos</a></li>
            <li><a href="{% url 'cuentas:crear_usuario' %}">➕ Nuevo usuario</a></li>
            <li><a href="{% url 'cursos:crear_curso' %}">➕ Nuevo curso</a></li>
            <li><a href="{% url 'estudiantes:kardex_items_listar' %}">🗂️ Kárdex</a></li>
            <li class="sep"></li>
            <li><a href="{% url 'estudiantes:listar' %}">👥 Estudiantes</a></li>
            <li><a href="{% url 'estudiantes:crear' %}">➕ Nuevo estudiante</a></li>

          {# --- Regente --- #}
          {% elif "regente" in role %}
            <li><a href="{% url 'cuentas:regente_dashboard' %}">📊 Resumen</a></li>
            <li><a href="{% url 'cursos:mis_cursos_regente' %}">📚 Mis cursos</a></li>

          {# --- Secretaría --- #}
          {% elif "secretaria" in role or "secretaría" in role %}
            <li><a href="{% url 'cuentas:secretaria_dashboard' %}">📊 Resumen</a></li>
            <li><a href="{% url 'cuentas:lista_usuarios' %}">📄 Usuarios</a></li>
            <li class="sep"></li>
            <li><a href="{% url 'estudiantes:listar' %}">👥 Estudiantes</a></li>
            <li><a href="{% url 'estudiantes:crear' %}">➕ Nuevo estudiante</a></li>
            <li><a href="{% url 'estudiantes:kardex_items_listar' %}">🗂️ Kárdex</a></li>

          {# --- Padre de familia --- #}
          {% elif "padre" in role %}
            <li><a href="{% url 'cuentas:padre_dashboard' %}">🏠 Inicio</a></li>
            <li><a href="{% url 'estudiantes:mis_hijos' %}">👨‍👩‍👧 Mis hijos</a></li>
          {% endif %}

          <li class="sep"></li>
          <li><a href="{% url 'cuentas:logout' %}">🚪 Cerrar sesión</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Contenido -->
    <main class="main">
      {% if messages %}
        <div class="msgs">
          {% for message in messages %}
            <div class="msg msg-{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Scripts -->
  <script>
    // Abrir/cerrar sidebar (si lo usas en responsive)
    function toggleSidebar() {
      const sidenav = document.querySelector('.sidenav');
      if (sidenav) sidenav.classList.toggle('open');
    }

    /*
      Evitar "volver atrás" en páginas autenticadas:
      - Si el usuario presiona Atrás, recargamos la misma URL (location.replace).
      - Si la página viene del back/forward cache (bfcache), forzamos recarga.
      Con headers no-store, si la sesión expiró, Django te enviará al login.
    */
    (function () {
      try {
        // Si la navegación viene del historial (bfcache), recarga dura
        var navEntries = performance.getEntriesByType && performance.getEntriesByType('navigation');
        if (navEntries && navEntries[0] && navEntries[0].type === 'back_forward') {
          location.replace(location.href);
          return;
        }
      } catch (_) {}

      // Asegura revalidación si el navegador intenta servir desde bfcache
      window.addEventListener('pageshow', function (evt) {
        if (evt.persisted) {
          location.replace(location.href);
        }
      });

      // Fija un estado y si el usuario pulsa Atrás, recarga esta misma URL
      try {
        history.replaceState({ locked: true }, '', location.href);
      } catch (_) {}

      window.addEventListener('popstate', function () {
        // Recarga y revalida en servidor (no-store + session check)
        location.replace(location.href);
      });
    })();
  </script>
  <script>
  // Evita clics múltiples en formularios y botones
  document.addEventListener("DOMContentLoaded", function () {
    const forms = document.querySelectorAll("form");
    forms.forEach(form => {
      form.addEventListener("submit", function (e) {
        const btn = form.querySelector("[type=submit]");
        if (btn) {
          btn.disabled = true;
          btn.innerText = "Procesando...";
        }
      });
    });

    // También evita múltiples clics en enlaces tipo botón
    const links = document.querySelectorAll("a, button");
    links.forEach(link => {
      link.addEventListener("click", function (e) {
        if (link.dataset.clicked === "true") {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
        link.dataset.clicked = "true";
        setTimeout(() => { link.dataset.clicked = "false"; }, 3000); // se reactiva tras 3s
      });
    });
  });
  (function () {
  let locked = false;
  let blockerFn = null;

  function addGlobalBlockers() {
    blockerFn = function (e) {
      if (locked) {
        e.stopPropagation();
        e.preventDefault();
        return false;
      }
    };
    // ¡En captura! para que intercepte antes que cualquier handler
    ['click', 'submit', 'keydown', 'touchstart'].forEach(type => {
      document.addEventListener(type, blockerFn, true);
    });
  }

  function removeGlobalBlockers() {
    if (!blockerFn) return;
    ['click', 'submit', 'keydown', 'touchstart'].forEach(type => {
      document.removeEventListener(type, blockerFn, true);
    });
    blockerFn = null;
  }

  function makeOverlay() {
    const ov = document.createElement('div');
    ov.id = 'ui-lock';
    ov.innerHTML = '<div class="ui-lock__box"><div class="ui-lock__spinner"></div><p>Procesando…</p></div>';
    document.body.appendChild(ov);
  }

  function disableInteractives() {
    const els = document.querySelectorAll('a, button, input, select, textarea, [tabindex]');
    els.forEach(el => {
      el.dataset.prevTabindex = el.getAttribute('tabindex') || '';
      el.setAttribute('tabindex', '-1');
      el.classList.add('is-disabled');
      if ('disabled' in el) el.disabled = true;
    });
  }

  function enableInteractives() {
    const els = document.querySelectorAll('.is-disabled');
    els.forEach(el => {
      if (el.dataset.prevTabindex !== undefined) {
        if (el.dataset.prevTabindex) el.setAttribute('tabindex', el.dataset.prevTabindex);
        else el.removeAttribute('tabindex');
      }
      el.classList.remove('is-disabled');
      if ('disabled' in el) el.disabled = false;
    });
  }

  function lockUI() {
    if (locked) return;
    locked = true;
    addGlobalBlockers();
    disableInteractives();
    makeOverlay();
  }

  function unlockUI() {
    locked = false;
    removeGlobalBlockers();
    enableInteractives();
    const ov = document.getElementById('ui-lock');
    if (ov) ov.remove();
  }

  // Exponer para casos AJAX
  window.unlockUI = unlockUI;

  document.addEventListener('DOMContentLoaded', function () {
    // Primer click en cualquier control navegable => lock
    document.addEventListener('click', function (e) {
      if (locked) return; // ya bloqueado
      const t = e.target.closest('a, button, input[type=submit], [type=submit]');
      if (!t) return;
      lockUI(); // NO prevenimos el primer click: la acción sigue su curso
    }, true);

    // Primer submit (por si viene de Enter o submit programático)
    document.addEventListener('submit', function () {
      if (!locked) lockUI();
    }, true);

    // Si la página navega, se descarga y el lock desaparece de forma natural.
    // (Si no hay navegación porque usas fetch/XHR, recuerda llamar window.unlockUI())
    window.addEventListener('pageshow', function (evt) {
      // Si se vuelve desde bfcache, por si acaso limpiamos overlay
      if (evt.persisted) unlockUI();
    });
  });
})();
</script>

</body>
{% endwith %}
</html>
