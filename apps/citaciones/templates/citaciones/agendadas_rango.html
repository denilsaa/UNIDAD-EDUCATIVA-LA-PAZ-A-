{% extends "layout/base_dashboard.html" %}
{% load static %}

{% block title %}Agenda de citaciones{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'citaciones/css/citaciones_agenda.css' %}">
{% endblock %}

{% block content %}
{% now "Y-m-d" as hoy %}
  <div class="dashboard-header">
    <h2 class="hdr-sub">
      Agenda de Citaciones
    </h2>
    <p>Consulta y gestión de citaciones programadas</p>
  </div>

  <form class="form-citaciones" method="get">
    <label>Desde:</label>
    <input type="date" name="desde" value="{{ desde|date:'Y-m-d' }}">
    <label>Días:</label>
    <input type="number" name="dias" min="1" max="31" value="{{ dias }}" class="input-dias">
    <button type="submit" class="btn-buscar">Ver</button>

    <a href="{% url 'citaciones:agendadas_rango' %}?desde={{ hoy|date:'Y-m-d' }}&dias={{ dias }}" class="btn-hoy">Hoy</a>
    <a href="{% url 'citaciones:agendadas_rango' %}?desde={{ prev_desde|date:'Y-m-d' }}&dias={{ dias }}" class="btn-navegar">⟵ Anterior</a>
    <a href="{% url 'citaciones:agendadas_rango' %}?desde={{ next_desde|date:'Y-m-d' }}&dias={{ dias }}" class="btn-navegar">Siguiente ⟶</a>

    <span class="total">Total: {{ total }}</span>
  </form>

  {% if por_dia and por_dia.items %}
    {% for dia, items in por_dia.items %}
      <h4 class="titulo-dia">{{ dia|date:"l d/m/Y" }}</h4>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Hora</th>
              <th>Estudiante</th>
              <th>Motivo</th>
              <th>Duración</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
          {% for c in items %}
            <tr>
              <td>{{ c.hora_citacion|time:"H:i" }}</td>
              <td>{{ c.estudiante }}</td>
              <td>{{ c.motivo_resumen }}</td>
              <td>{{ c.duracion_min }} min</td>
              <td>
                <a href="{% url 'citaciones:editar_form' c.id %}" class="btn-editar">Editar</a>
                <button class="btn-notificar" data-id="{{ c.id }}">Mandar notificación</button>
                <button class="btn-eliminar btn-cancelar" data-id="{{ c.id }}">Cancelar</button>
               </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% empty %}
      <div class="alerta">No hay citaciones agendadas en el rango.</div>
    {% endfor %}
  {% else %}
    <div class="alerta">No hay citaciones agendadas en el rango.</div>
  {% endif %}

<script>
function getCookie(name) {
  const v = `; ${document.cookie}`.split(`; ${name}=`);
  if (v.length === 2) return v.pop().split(";").shift();
}

async function post(url, data) {
  const body = new URLSearchParams(data || {});
  const resp = await fetch(url, {
    method: "POST",
    headers: {
      "X-Requested-With": "XMLHttpRequest",
      "X-CSRFToken": getCookie("csrftoken"),
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body,
  });
  return resp.json();
}

document.addEventListener("click", async (e) => {
  // Cancelar
  const cancelBtn = e.target.closest(".btn-cancelar");
  if (cancelBtn) {
    const id = cancelBtn.dataset.id;
    if (!confirm("¿Cancelar esta citación?")) return;
    const r = await post(`/citaciones/${id}/rechazar/`);
    if (r.ok) {
      location.reload();
    } else {
      alert(r.error || "Error al cancelar");
    }
    return;
  }

  // Mandar notificación
  const notifBtn = e.target.closest(".btn-notificar");
  if (notifBtn) {
    const id = notifBtn.dataset.id;
    const r = await post(`/citaciones/${id}/notificar/`);
    if (r.ok) {
      alert("Notificación enviada al padre de familia.");
    } else {
      alert(r.error || "Error al enviar la notificación");
    }
  }
});
</script>

{% endblock %}
