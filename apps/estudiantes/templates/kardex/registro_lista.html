{% extends "layout/base_dashboard.html" %}
{% load static %}

{% block title %}Kárdex del estudiante{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'estudiantes/css/registro_diario.css' %}">
{% endblock %}

{% block content %}
  <!-- === ENCABEZADO === -->
  <div class="dashboard-header">
    <h2 class="hdr-sub">
      Kárdex
    </h2>
    <p>Listado Kárdex por estudiante</p>
  </div>

  <!-- Cabecera -->
  <div class="card-info">
    <div class="card-row">
      <span class="label">Estudiante:</span>
      <span class="value">{{ estudiante.apellidos }} {{ estudiante.nombres }}</span>
    </div>
    <div class="card-row">
      <span class="label">Curso:</span>
      <span class="value">{{ estudiante.curso }}</span>
      <span class="label">Nº Lista:</span>
      <span class="value">{{ estudiante.nro_lista|default:"  " }}</span>
      <span class="label">Año:</span>
      <span class="value">{{ estudiante.anio|default:"  " }}</span>
    </div>
    <div class="card-row">
      <span class="label">Padre/Madre/Tutor:</span>
      <span class="value">{{ estudiante.padre|default:"—" }}</span>
    </div>
  </div>

  <div class="action-buttons">
    {# Secretaría NO puede añadir registro #}
    {% if not "secretaria" in role and not "secretaría" in role %}
      <a href="{% url 'estudiantes:kardex_nuevo' estudiante.id %}" class="btn-registro">Añadir registro</a>
    {% endif %}
    <a href="{% url 'estudiantes:listar' %}" class="btn-volver">Volver a estudiantes</a>
  </div>

  <!-- Grilla tipo planilla -->
  <div class="tabla-scroll">
    <table class="tabla tabla-kardex">
      <thead>
        <tr>
          <th rowspan="2" style="min-width:40px">Nro.</th>
          <th rowspan="2" style="min-width:100px">Fecha</th>
          <th rowspan="2" style="min-width:120px">Sello del maestro</th>

          <!-- Bloques de columnas por dimensión -->
          <th colspan="{{ ser_cols|length }}">SER</th>
          <th colspan="{{ saber_cols|length }}">SABER</th>
          <th colspan="{{ hacer_cols|length }}">HACER</th>
          <th colspan="{{ decidir_cols|length }}">DECIDIR</th>

          <th rowspan="2" style="min-width:200px">Otras observaciones / acciones tomadas</th>
          <th rowspan="2" style="min-width:160px">Firma del padre/tutor</th>
        </tr>
        <tr>
          {% for c in ser_cols %}<th class="th-rotado">{{ c.descripcion }}</th>{% endfor %}
          {% for c in saber_cols %}<th class="th-rotado">{{ c.descripcion }}</th>{% endfor %}
          {% for c in hacer_cols %}<th class="th-rotado">{{ c.descripcion }}</th>{% endfor %}
          {% for c in decidir_cols %}<th class="th-rotado">{{ c.descripcion }}</th>{% endfor %}
        </tr>
      </thead>

      <tbody>
        {% for r in filas %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ r.fecha }}{% if r.hora %} {{ r.hora }}{% endif %}</td>
            <td>{% if r.sello_maestro %}✔{% endif %}</td>

            {# Para cada dimensión, marcamos la columna cuyo c.id coincide con r.kardex_item_id #}
            {% for c in ser_cols %}<td class="mark">{% if r.kardex_item_id == c.id %}✔{% endif %}</td>{% endfor %}
            {% for c in saber_cols %}<td class="mark">{% if r.kardex_item_id == c.id %}✔{% endif %}</td>{% endfor %}
            {% for c in hacer_cols %}<td class="mark">{% if r.kardex_item_id == c.id %}✔{% endif %}</td>{% endfor %}
            {% for c in decidir_cols %}<td class="mark">{% if r.kardex_item_id == c.id %}✔{% endif %}</td>{% endfor %}

            <td class="col-observaciones">{{ r.observacion|default:"—" }}</td>
            <td><!-- firma física --></td>
          </tr>
        {% empty %}
          {% for i in "123456789012345"|make_list %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>—</td>
            <td></td>
            {% for c in ser_cols %}<td></td>{% endfor %}
            {% for c in saber_cols %}<td></td>{% endfor %}
            {% for c in hacer_cols %}<td></td>{% endfor %}
            {% for c in decidir_cols %}<td></td>{% endfor %}
            <td></td><td></td>
          </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
