{% extends "layout/base_dashboard.html" %}
{% block title %}Estudiantes – {{ curso }}{% endblock %}

{% block content %}
<h2 style="text-align:center">Estudiantes de {{ curso }}</h2>

{% with role=request.user.rol.nombre|default_if_none:""|default:""|lower %}
<form method="get" class="mb-3">
  <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Buscar por apellidos, nombres o CI">
  <button type="submit">Buscar</button>
  <span style="margin-left:1rem">Total: {{ total }}</span>
  <span style="float:right">
    <a href="{% if 'regente' in role %}{% url 'cursos:mis_cursos_regente' %}{% else %}{% url 'cursos:lista_cursos' %}{% endif %}">← Volver a cursos</a>
  </span>
</form>

<table class="tabla">
  <thead>
    <tr>
      <th>#</th>
      <th>Apellidos</th>
      <th>Nombres</th>
      <th>CI</th>
      <th>Padre/Tutor</th>
      <th>Kárdex</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for e in object_list %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ e.apellidos }}</td>
      <td>{{ e.nombres }}</td>
      <td>{{ e.ci }}</td>
      <td>{{ e.padre|default:"—" }}</td>
      <td>{% if e.kardex_id %}Asignado{% else %}—{% endif %}</td>
      <td>
        {# Solo Director/Secretaría ven "Editar" #}
        {% if "director" in role or "secretaria" in role or "secretaría" in role %}
          <a href="{% url 'estudiantes:editar' e.pk %}">Editar</a> |
        {% endif %}

        <a href="{% url 'estudiantes:kardex_listar' e.pk %}">Ver kárdex</a>

        {# Director/Regente/Secretaría pueden agregar registro de kárdex #}
        {% if "director" in role or "regente" in role or "secretaria" in role or "secretaría" in role %}
          | <a href="{% url 'estudiantes:kardex_nuevo' e.pk %}">+ Registro</a>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="7">No hay estudiantes en este curso.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endwith %}
{% endblock %}
